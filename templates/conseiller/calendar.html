{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Calendrier" %} - Assur'aimant{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="{ calendarModalOpen: false, calendarSelectedDate: '', calendarSelectedTime: '09:00' }">
    <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{% trans "Calendrier des rendez-vous" %}</h1>
            <p class="text-base text-gray-600">{% trans "Gérez vos rendez-vous et vos indisponibilités" %}</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="{% url 'insurance_web:conseiller_add_unavailability' %}?next={{ request.get_full_path|urlencode }}" class="btn-secondary px-4 py-2 text-sm inline-flex items-center">
                <span class="mr-2">+</span>
                {% trans "Indisponibilité" %}
            </a>
            <a href="{% url 'insurance_web:conseiller_dashboard' %}" class="btn-secondary px-6 py-3 inline-flex items-center">
                {% trans "Retour au Tableau de bord" %}
            </a>
        </div>
    </div>

    <div class="card p-4 mb-6 overflow-x-auto">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <a href="?week_start={{ prev_week|date:'Y-m-d' }}" class="p-2 text-gray-700 hover:bg-gray-100 rounded border border-gray-200 text-sm font-medium">
                    ‹ {% trans "Semaine précédente" %}
                </a>
                <span class="text-lg font-bold text-gray-900 px-2">
                    {{ week_dates.0|date:"d/m" }} – {{ week_dates.6|date:"d/m/Y" }}
                </span>
                <a href="?week_start={{ next_week|date:'Y-m-d' }}" class="p-2 text-gray-700 hover:bg-gray-100 rounded border border-gray-200 text-sm font-medium">
                    {% trans "Semaine suivante" %} ›
                </a>
            </div>
        </div>
        <table class="w-full border-collapse min-w-[800px]">
            <thead>
                <tr class="border-b-2 border-gray-300">
                    <th class="w-20 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">{% trans "Heure" %}</th>
                    {% for d in week_dates %}
                    {% with day_of_week=d|date:"w" %}
                    <th class="py-3 px-2 text-center border-l border-gray-200 
                        {% if d == today %}bg-primary/10 text-primary font-semibold
                        {% elif day_of_week == '0' or day_of_week == '6' %}bg-gray-50 text-gray-400
                        {% elif d < today %}bg-gray-50 text-gray-300
                        {% else %}text-gray-700 font-medium{% endif %}">
                        <div class="text-xs uppercase tracking-wide mb-1">{{ d|date:"D" }}</div>
                        <div class="text-lg font-bold">{{ d.day }}</div>
                    </th>
                    {% endwith %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour, label, row in slots_grid %}
                <tr class="border-t border-gray-100 hover:bg-gray-50/50 transition-colors">
                    <td class="py-2 pr-3 text-xs font-medium text-gray-500 align-top">{{ label }}</td>
                    {% for d, ev in row %}
                    {% with day_of_week=d|date:"w" date_str=d|date:"Y-m-d" %}
                    {% if ev %}
                        {% if ev.type == 'appointment' %}
                        <td class="border-l border-gray-100 align-top p-0.5 min-w-[100px] min-h-[44px] {% if d == today %}bg-blue-50/30{% endif %}">
                            <a href="{% url 'insurance_web:appointment_detail' ev.obj.id %}" class="block text-xs rounded-md px-2 py-1.5 border transition-all hover:shadow-sm {% if ev.obj.status == 'confirmed' %}bg-green-50 border-green-200 text-green-800 hover:bg-green-100 hover:border-green-300{% elif ev.obj.status == 'pending' %}bg-yellow-50 border-yellow-200 text-yellow-800 hover:bg-yellow-100 hover:border-yellow-300{% else %}bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100 hover:border-gray-300{% endif %}" title="{{ ev.obj.client.get_full_name|default:ev.obj.client.email }} - {{ ev.obj.date_time|date:'H:i' }} ({{ ev.obj.duration_minutes }} min)">
                                <span class="font-semibold text-xs">{{ ev.obj.date_time|date:"H:i" }}</span>
                                <span class="block truncate text-xs mt-0.5">{{ ev.obj.client.get_full_name|default:ev.obj.client.email|truncatechars:12 }}</span>
                            </a>
                        </td>
                        {% else %}
                        <td class="border-l border-gray-100 align-top p-0.5 min-w-[100px] min-h-[44px] {% if d == today %}bg-gray-50/50{% endif %}">
                            <div class="relative w-full min-h-[42px] rounded border border-gray-300 bg-gray-200 group hover:bg-gray-250 transition-colors">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-xs text-gray-500 font-medium">{% trans "Indisponible" %}</span>
                                </div>
                                <form method="post" action="{% url 'insurance_web:conseiller_delete_unavailability' ev.obj.id %}" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity z-10" data-confirm="{% trans 'Retirer cette indisponibilité ?' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="week_start" value="{{ week_start|date:'Y-m-d' }}">
                                    <button type="submit" class="w-5 h-5 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-300 rounded text-xs font-bold" title="{% trans 'Retirer' %}">×</button>
                                </form>
                            </div>
                        </td>
                        {% endif %}
                    {% else %}
                        {% if day_of_week == '0' or day_of_week == '6' %}
                        <td class="border-l border-gray-100 align-top p-0.5 min-w-[100px] min-h-[44px] bg-gray-50">
                            <div class="w-full h-full min-h-[42px] bg-gray-50 rounded border-0"></div>
                        </td>
                        {% elif d < today %}
                        <td class="border-l border-gray-100 align-top p-0.5 min-w-[100px] min-h-[44px] bg-gray-50">
                            <div class="w-full h-full min-h-[42px] bg-gray-50 rounded border-0"></div>
                        </td>
                        {% else %}
                        <td class="border-l border-gray-100 align-top p-0.5 min-w-[100px] min-h-[44px] {% if d == today %}bg-blue-50/30{% endif %}" 
                            x-data="{ 
                                isPastTime: false,
                                init() {
                                    const dateStr = '{{ date_str }}';
                                    const timeStr = '{{ label }}';
                                    const [year, month, day] = dateStr.split('-').map(Number);
                                    const [hours, minutes] = timeStr.split(':').map(Number);
                                    const slotDateTime = new Date(year, month - 1, day, hours, minutes);
                                    this.isPastTime = slotDateTime < new Date();
                                }
                            }">
                            <button type="button" 
                                    x-show="!isPastTime"
                                    @click="calendarSelectedDate = '{{ date_str }}'; calendarSelectedTime = '{{ label }}'; calendarModalOpen = true" 
                                    class="w-full h-full min-h-[42px] text-gray-400 hover:text-primary hover:bg-primary/10 border border-transparent hover:border-primary/20 rounded transition-all duration-150 flex items-center justify-center group">
                                <span class="text-lg opacity-40 group-hover:opacity-100 group-hover:scale-110 transition-all">+</span>
                            </button>
                            <div x-show="isPastTime" 
                                 class="w-full h-full min-h-[42px] bg-gray-50 rounded border-0"></div>
                        </td>
                        {% endif %}
                    {% endif %}
                    {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <p class="text-sm text-gray-500 mb-4">{% trans "Cliquez sur un créneau vide pour créer un rendez-vous." %}</p>

    <!-- Modal : créer un rendez-vous -->
    <div x-show="calendarModalOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true" x-transition>
        <div class="fixed inset-0 bg-black/50" @click="calendarModalOpen = false"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6" @click.stop>
                <h3 class="text-lg font-bold text-gray-900 mb-4">{% trans "Créer un rendez-vous" %}</h3>
                <form method="post" action="{% url 'insurance_web:conseiller_calendar_create' %}">
                    {% csrf_token %}
                    <input type="hidden" name="date" :value="calendarSelectedDate">
                    <input type="hidden" name="week_start" value="{{ week_start|date:'Y-m-d' }}">
                    <div class="space-y-4">
                        <div>
                            <label for="calendar-create-client" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Client" %}</label>
                            <select id="calendar-create-client" name="client_id" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">{% trans "Choisir un client" %}</option>
                                {% for client in calendar_clients %}<option value="{{ client.id }}">{{ client.get_full_name|default:client.email }}</option>{% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="calendar-create-time" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Heure" %}</label>
                            <input type="time" id="calendar-create-time" name="time" x-model="calendarSelectedTime" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="09:00">
                        </div>
                        <div>
                            <label for="calendar-create-duration" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Durée (minutes)" %}</label>
                            <input type="number" id="calendar-create-duration" name="duration_minutes" min="15" max="240" value="60" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="calendar-create-notes" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Notes (optionnel)" %}</label>
                            <textarea id="calendar-create-notes" name="notes" rows="2" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="{% trans 'Informations complémentaires...' %}"></textarea>
                        </div>
                    </div>
                    <p class="mt-3 text-sm text-gray-500" x-show="calendarSelectedDate">{% trans "Date" %}: <span x-text="calendarSelectedDate"></span></p>
                    <div class="mt-6 flex gap-3">
                        <button type="submit" class="btn-primary flex-1 py-3">{% trans "Créer le rendez-vous" %}</button>
                        <button type="button" @click="calendarModalOpen = false" class="btn-secondary py-3">{% trans "Annuler" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
