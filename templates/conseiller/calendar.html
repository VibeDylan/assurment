{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Calendrier" %} - Assur'aimant{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="{ calendarModalOpen: false, calendarSelectedDate: '', calendarSelectedTime: '09:00' }">
    <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{% trans "Calendrier des rendez-vous" %}</h1>
            <p class="text-base text-gray-600">{% trans "Gérez vos rendez-vous et vos indisponibilités" %}</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="{% url 'insurance_web:conseiller_add_unavailability' %}?next={{ request.get_full_path|urlencode }}" class="btn-secondary px-4 py-2 text-sm inline-flex items-center">
                <span class="mr-2">+</span>
                {% trans "Indisponibilité" %}
            </a>
            <a href="{% url 'insurance_web:conseiller_dashboard' %}" class="btn-secondary px-6 py-3 inline-flex items-center">
                {% trans "Retour au Tableau de bord" %}
            </a>
        </div>
    </div>

    <div class="card p-4 mb-6 overflow-x-auto">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <a href="?week_start={{ prev_week|date:'Y-m-d' }}" class="p-2 text-gray-700 hover:bg-gray-100 rounded border border-gray-200 text-sm font-medium">
                    ‹ {% trans "Semaine précédente" %}
                </a>
                <span class="text-lg font-bold text-gray-900 px-2">
                    {{ week_dates.0|date:"d/m" }} – {{ week_dates.6|date:"d/m/Y" }}
                </span>
                <a href="?week_start={{ next_week|date:'Y-m-d' }}" class="p-2 text-gray-700 hover:bg-gray-100 rounded border border-gray-200 text-sm font-medium">
                    {% trans "Semaine suivante" %} ›
                </a>
            </div>
        </div>
        <table class="w-full border-collapse min-w-[800px]">
            <thead>
                <tr>
                    <th class="w-16 py-2 text-left text-xs font-bold text-gray-600 uppercase">{% trans "Heure" %}</th>
                    {% for d in week_dates %}
                    <th class="py-2 px-1 text-center text-xs font-bold text-gray-600 border-l border-gray-200 {% if d == today %}bg-primary/10{% endif %}">
                        {{ d|date:"D" }}<br><span class="text-base">{{ d.day }}</span>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour, label, row in slots_grid %}
                <tr class="border-t border-gray-200">
                    <td class="py-1 pr-2 text-xs font-semibold text-gray-600 align-top">{{ label }}</td>
                    {% for d, ev in row %}
                    <td class="border-l border-gray-100 align-top p-0.5 min-w-[100px] min-h-[44px] {% if d == today %}bg-gray-50/50{% endif %}">
                        {% if ev %}
                        {% if ev.type == 'appointment' %}
                        <a href="{% url 'insurance_web:appointment_detail' ev.obj.id %}" class="block text-xs rounded px-2 py-1.5 border {% if ev.obj.status == 'confirmed' %}bg-green-100 border-green-300 text-green-900 hover:bg-green-200{% elif ev.obj.status == 'pending' %}bg-yellow-100 border-yellow-300 text-yellow-900 hover:bg-yellow-200{% else %}bg-gray-100 border-gray-200 text-gray-900{% endif %} transition-colors" title="{{ ev.obj.client.get_full_name|default:ev.obj.client.email }} - {{ ev.obj.date_time|date:'H:i' }} ({{ ev.obj.duration_minutes }} min)">
                            <span class="font-semibold">{{ ev.obj.date_time|date:"H:i" }}</span>
                            <span class="block truncate">{{ ev.obj.client.get_full_name|default:ev.obj.client.email|truncatechars:14 }}</span>
                        </a>
                        {% else %}
                        <div class="relative w-full min-h-[42px] rounded-md overflow-hidden group bg-gray-200" style="background-image: linear-gradient(135deg, transparent 47%, #9ca3af 47%, #9ca3af 53%, transparent 53%);">
                            <form method="post" action="{% url 'insurance_web:conseiller_delete_unavailability' ev.obj.id %}" class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-gray-200/95" data-confirm="{% trans 'Retirer cette indisponibilité ?' %}">
                                {% csrf_token %}
                                <input type="hidden" name="week_start" value="{{ week_start|date:'Y-m-d' }}">
                                <button type="submit" class="p-1.5 text-gray-500 hover:text-gray-700 rounded hover:bg-gray-300 text-sm leading-none" title="{% trans 'Retirer' %}">×</button>
                            </form>
                        </div>
                        {% endif %}
                        {% else %}
                        <button type="button" @click="calendarSelectedDate = '{{ d|date:'Y-m-d' }}'; calendarSelectedTime = '{{ label }}'; calendarModalOpen = true" class="w-full h-full min-h-[42px] text-xs font-medium text-gray-400 hover:text-primary hover:bg-primary/5 border border-dashed border-gray-200 hover:border-primary/30 rounded px-2 py-1.5 transition-colors flex items-center justify-center">
                            +
                        </button>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <p class="text-sm text-gray-500 mb-4">{% trans "Cliquez sur un créneau vide pour créer un rendez-vous." %}</p>

    <!-- Modal : créer un rendez-vous -->
    <div x-show="calendarModalOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true" x-transition>
        <div class="fixed inset-0 bg-black/50" @click="calendarModalOpen = false"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6" @click.stop>
                <h3 class="text-lg font-bold text-gray-900 mb-4">{% trans "Créer un rendez-vous" %}</h3>
                <form method="post" action="{% url 'insurance_web:conseiller_calendar_create' %}">
                    {% csrf_token %}
                    <input type="hidden" name="date" :value="calendarSelectedDate">
                    <input type="hidden" name="week_start" value="{{ week_start|date:'Y-m-d' }}">
                    <div class="space-y-4">
                        <div>
                            <label for="calendar-create-client" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Client" %}</label>
                            <select id="calendar-create-client" name="client_id" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">{% trans "Choisir un client" %}</option>
                                {% for client in calendar_clients %}<option value="{{ client.id }}">{{ client.get_full_name|default:client.email }}</option>{% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="calendar-create-time" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Heure" %}</label>
                            <input type="time" id="calendar-create-time" name="time" x-model="calendarSelectedTime" required class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="09:00">
                        </div>
                        <div>
                            <label for="calendar-create-duration" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Durée (minutes)" %}</label>
                            <input type="number" id="calendar-create-duration" name="duration_minutes" min="15" max="240" value="60" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="calendar-create-notes" class="block text-sm font-semibold text-gray-700 mb-1">{% trans "Notes (optionnel)" %}</label>
                            <textarea id="calendar-create-notes" name="notes" rows="2" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-md text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="{% trans 'Informations complémentaires...' %}"></textarea>
                        </div>
                    </div>
                    <p class="mt-3 text-sm text-gray-500" x-show="calendarSelectedDate">{% trans "Date" %}: <span x-text="calendarSelectedDate"></span></p>
                    <div class="mt-6 flex gap-3">
                        <button type="submit" class="btn-primary flex-1 py-3">{% trans "Créer le rendez-vous" %}</button>
                        <button type="button" @click="calendarModalOpen = false" class="btn-secondary py-3">{% trans "Annuler" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
